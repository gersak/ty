{% extends "base.html" %}

{% block title %}Calendar & Date Components - Ty Components Demo{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Page Header -->
    <div class="text-center mb-16">
        <h1 class="text-4xl md:text-5xl font-bold mb-6">
            <span class="text-gradient-primary">üìÖ Calendar</span>
            <span class="ty-text-primary-strong"> Component Excellence</span>
        </h1>
        <p class="text-xl ty-text-neutral-mild max-w-3xl mx-auto">
            Showcasing component-native patterns with smart event loading, intelligent caching, and graceful fallbacks. No HTMX required.
        </p>
    </div>



    <!-- Calendar Components Demo -->
    <div class="mb-20">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold ty-text-primary-strong mb-4">
                üåü Smart Event Calendar
            </h2>
            <p class="text-lg ty-text-neutral-mild">
                Component excellence with instant navigation, intelligent caching, and graceful error handling
            </p>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
            
            <!-- Example 1: Basic Event Calendar -->
            <div class="glass-card">
                <div class="flex items-center mb-6">
                    <div class="feature-icon ty-bg-primary-soft mr-4">
                        <ty-icon name="calendar-days" class="ty-text-primary-strong"></ty-icon>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold ty-text-primary-strong">Smart Event Loading</h3>
                        <p class="ty-text-neutral-mild">Instant navigation, background prefetching, graceful fallbacks</p>
                    </div>
                </div>
                
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Calendar Component -->
                    <div class="lg:flex-1 ty-elevated rounded-xl p-6 max-w-4xl">
                        <ty-calendar id="event-calendar"
                                    show-navigation="true"
                                    size="lg">
                        </ty-calendar>
                    </div>
                    
                    <!-- Event List -->
                    <div class="lg:w-80 lg:flex-shrink-0">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold ty-text-neutral-strong">
                                <span id="events-month-header">Events This Month</span>
                            </h4>
                            <div class="htmx-indicator" id="events-loading">
                                <div class="spinner ty-text-primary"></div>
                            </div>
                        </div>
                        <div id="event-list" class="space-y-3">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Interactive Calendar Example -->
            <div class="glass-card">
                <div class="flex items-center mb-6">
                    <div class="feature-icon ty-bg-success-soft mr-4">
                        <ty-icon name="calendar-check" class="ty-text-success-strong"></ty-icon>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold ty-text-success-strong">Component Excellence</h3>
                        <p class="ty-text-neutral-mild">Smart event loading, instant navigation, graceful fallbacks</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="ty-bg-success-soft rounded-lg p-4">
                        <h4 class="font-semibold ty-text-success-strong mb-2">‚ú® Features Demonstrated</h4>
                        <ul class="text-sm ty-text-success-mild space-y-1">
                            <li>‚Ä¢ Instant month navigation (no loading delays)</li>
                            <li>‚Ä¢ Background event fetching with smart caching</li>
                            <li>‚Ä¢ Event count badges on calendar days</li>
                            <li>‚Ä¢ Automatic adjacent month prefetching</li>
                            <li>‚Ä¢ Graceful error handling and offline mode</li>
                        </ul>
                    </div>
                    
                    <div class="ty-bg-info-soft rounded-lg p-4">
                        <h4 class="font-semibold ty-text-info-strong mb-2">üõ† Technical Excellence</h4>
                        <ul class="text-sm ty-text-info-mild space-y-1">
                            <li>‚Ä¢ Web Components with native browser APIs</li>
                            <li>‚Ä¢ Async/await with intelligent batching</li>
                            <li>‚Ä¢ In-memory caching with LRU eviction</li>
                            <li>‚Ä¢ Progressive enhancement layers</li>
                            <li>‚Ä¢ Zero dependencies beyond Ty core</li>
                        </ul>
                    </div>
                    
                    <div class="ty-bg-neutral-soft rounded-lg p-4">
                        <h4 class="font-semibold ty-text-neutral-strong mb-2">üîç Try It Out</h4>
                        <p class="text-sm ty-text-neutral-mild mb-3">Open browser dev tools and navigate months to see:</p>
                        <ul class="text-xs ty-text-neutral-mild space-y-1">
                            <li>‚Ä¢ Console logs showing cache hits/misses</li>
                            <li>‚Ä¢ Background prefetching of adjacent months</li>
                            <li>‚Ä¢ Event count loading for calendar badges</li>
                            <li>‚Ä¢ Debug tools: <code>window.calendarDemo.getCacheStatus()</code></li>
                        </ul>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<script>
// üåü COMPONENT EXCELLENCE CALENDAR
// Minimal, elegant code showcasing smart event loading with graceful fallbacks

console.group('üìÖ Calendar Component Excellence Demo');
console.log('‚ú® Focusing on component-native patterns, not framework integration');
console.log('üéØ Goals: Instant navigation, smart caching, graceful degradation');
console.groupEnd();

// üíæ Smart Event Cache with LRU eviction
class EventCache {
    constructor(maxSize = 6) { // Cache 6 months (current + 5 adjacent)
        this.cache = new Map();
        this.maxSize = maxSize;
    }
    
    get(key) {
        if (this.cache.has(key)) {
            // Move to end (most recently used)
            const value = this.cache.get(key);
            this.cache.delete(key);
            this.cache.set(key, value);
            return value;
        }
        return null;
    }
    
    set(key, value) {
        if (this.cache.has(key)) {
            this.cache.delete(key);
        } else if (this.cache.size >= this.maxSize) {
            // Remove oldest entry
            const firstKey = this.cache.keys().next().value;
            this.cache.delete(firstKey);
        }
        this.cache.set(key, value);
    }
    
    has(key) {
        return this.cache.has(key);
    }
    
    clear() {
        this.cache.clear();
    }
}

// üöÄ Calendar Event Manager - Component Excellence Pattern with Shared State
class CalendarEventManager {
    constructor() {
        this.cache = new EventCache();
        this.loadingStates = new Set();
        this.eventListElement = document.getElementById('event-list');
        this.monthHeaderElement = document.getElementById('events-month-header');
        this.loadingIndicator = document.getElementById('events-loading');
        
        // üéØ SHARED STATE - Single source of truth
        this.currentEvents = []; // Array of event objects
        this.currentMonth = null;
        this.currentYear = null;
        this.eventCountsByDate = {}; // For calendar badges
        
        // Month names for display
        this.monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
    }
    
    // üìç Generate cache key for month/year
    getCacheKey(year, month) {
        return `${year}-${month.toString().padStart(2, '0')}`;
    }
    
    // üé® Update UI with loading state
    showLoading(show = true) {
        if (this.loadingIndicator) {
            this.loadingIndicator.style.display = show ? 'block' : 'none';
        }
    }
    
    // üìã Update month header
    updateMonthHeader(year, month) {
        if (this.monthHeaderElement) {
            const monthName = this.monthNames[month - 1];
            this.monthHeaderElement.textContent = `${monthName} ${year} Events`;
        }
    }
    
    // üéØ Fetch events from server with error handling - NOW RETURNS JSON
    async fetchEventsFromServer(year, month) {
        const cacheKey = this.getCacheKey(year, month);
        
        try {
            console.log(`üì° Fetching events JSON for ${year}-${month}`);
            const response = await fetch(`/api/calendar/events?year=${year}&month=${month}`);
            
            if (!response.ok) {
                throw new Error(`Server responded with ${response.status}`);
            }
            
            const data = await response.json();
            
            // Cache the JSON data (not HTML)
            this.cache.set(cacheKey, data);
            console.log(`‚úÖ Cached ${data.events.length} events for ${cacheKey}`);
            
            return data;
            
        } catch (error) {
            console.warn(`‚ö†Ô∏è Failed to load events for ${year}-${month}:`, error.message);
            
            // Return graceful fallback data
            return this.createFallbackData(year, month);
        }
    }
    
    // üõ°Ô∏è Create fallback data for when server fails
    createFallbackData(year, month) {
        return {
            events: [],
            month: month,
            year: year,
            total_count: 0,
            error: true
        };
    }
    
    // üîÑ Update shared state and trigger both UI updates
    updateSharedState(data) {
        this.currentEvents = data.events || [];
        this.currentMonth = data.month;
        this.currentYear = data.year;
        
        // Generate event counts by date for calendar badges
        this.eventCountsByDate = {};
        this.currentEvents.forEach(event => {
            const dateKey = event.date; // Already in YYYY-MM-DD format
            this.eventCountsByDate[dateKey] = (this.eventCountsByDate[dateKey] || 0) + 1;
        });
        
        console.log(`üîÑ Shared state updated: ${this.currentEvents.length} events, ${Object.keys(this.eventCountsByDate).length} days with events`);
    }
    
    // üé® Render event list from shared state (client-side rendering)
    renderEventList() {
        if (!this.eventListElement) return;
        
        // Handle error state
        if (this.currentEvents.length === 0) {
            const monthName = this.monthNames[this.currentMonth - 1];
            this.eventListElement.innerHTML = `
                <div class="ty-bg-neutral-soft rounded-lg p-6 text-center animate-fade-in">
                    <ty-icon name="calendar" class="w-12 h-12 mx-auto mb-3 ty-text-neutral-mild"></ty-icon>
                    <p class="font-medium ty-text-neutral-strong">No Events This Month</p>
                    <p class="text-sm ty-text-neutral-mild">${monthName} ${this.currentYear} is currently clear</p>
                </div>
            `;
            return;
        }
        
        // Render events from shared state
        let eventsHTML = '<div class="animate-fade-in space-y-3">';
        
        this.currentEvents.forEach(event => {
            const monthName = this.monthNames[this.currentMonth - 1];
            eventsHTML += `
                <div class="flex items-center space-x-3 ty-bg-${event.color}-soft rounded-lg p-3 hover:shadow-sm transition-shadow">
                    <div class="flex-shrink-0">
                        <ty-icon name="${event.icon}" class="ty-text-${event.color}-strong"></ty-icon>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium ty-text-${event.color}-strong truncate">${event.title}</p>
                        <p class="text-sm ty-text-neutral-mild">${monthName} ${event.day}, ${this.currentYear} at ${event.time}</p>
                    </div>
                    <div class="flex-shrink-0">
                        <div class="w-4 h-4 rounded-full shadow-sm border-2 border-white " style="background-color:var(--ty-color-${event.color})"></div>
                    </div>
                </div>
            `;
        });
        
        eventsHTML += '</div>';
        this.eventListElement.innerHTML = eventsHTML;
    }
    
    // üìÖ Main method: Load and display events for a month with shared state
    async loadEvents(year, month, options = {}) {
        const { updateHeader = true, showLoader = true } = options;
        const cacheKey = this.getCacheKey(year, month);
        
        // Update header immediately (no waiting)
        if (updateHeader) {
            this.updateMonthHeader(year, month);
        }
        
        // Check cache first
        const cached = this.cache.get(cacheKey);
        if (cached) {
            console.log(`‚ö° Using cached events for ${cacheKey}`);
            this.updateSharedState(cached);
            this.renderEventList();
            this.prefetchAdjacentMonths(year, month); // Background prefetch
            return cached; // Return data for calendar badges
        }
        
        // Prevent duplicate requests
        if (this.loadingStates.has(cacheKey)) {
            console.log(`‚è≥ Already loading ${cacheKey}, skipping duplicate request`);
            return null;
        }
        
        this.loadingStates.add(cacheKey);
        
        if (showLoader) {
            this.showLoading(true);
        }
        
        try {
            // Fetch from server
            const data = await this.fetchEventsFromServer(year, month);
            
            // Update shared state and render both calendar + list
            this.updateSharedState(data);
            this.renderEventList();
            
            // Background prefetch adjacent months
            this.prefetchAdjacentMonths(year, month);
            
            return data; // Return data for calendar badges
            
        } finally {
            this.loadingStates.delete(cacheKey);
            if (showLoader) {
                this.showLoading(false);
            }
        }
    }
    
    // üîÆ Intelligent prefetching of adjacent months
    async prefetchAdjacentMonths(year, month) {
        const adjacentMonths = [
            { year: month === 1 ? year - 1 : year, month: month === 1 ? 12 : month - 1 }, // Previous
            { year: month === 12 ? year + 1 : year, month: month === 12 ? 1 : month + 1 }  // Next
        ];
        
        for (const { year: adjYear, month: adjMonth } of adjacentMonths) {
            const cacheKey = this.getCacheKey(adjYear, adjMonth);
            
            if (!this.cache.has(cacheKey) && !this.loadingStates.has(cacheKey)) {
                console.log(`üîÆ Prefetching ${cacheKey}`);
                
                // Prefetch without showing loader or updating UI
                this.loadingStates.add(cacheKey);
                
                try {
                    await this.fetchEventsFromServer(adjYear, adjMonth);
                } catch (error) {
                    console.log(`‚ö†Ô∏è Prefetch failed for ${cacheKey}:`, error.message);
                } finally {
                    this.loadingStates.delete(cacheKey);
                }
            }
        }
    }
    
    // üìä Get event counts for calendar badges from shared state
    getEventCounts() {
        return this.eventCountsByDate;
    }
    
    // üßπ Clear all cached data (for testing)
    clearCache() {
        this.cache.clear();
        this.currentEvents = [];
        this.eventCountsByDate = {};
        console.log('üßπ Event cache and shared state cleared');
    }
}

// Helper function to safely refresh calendar
function safeRefreshCalendar(calendar, context = 'unknown') {
    if (calendar && typeof calendar.refresh === 'function') {
        console.log(`üé® Refreshing calendar (${context})`);
        calendar.refresh();
    } else {
        console.warn(`‚ö†Ô∏è Calendar refresh method not available (${context})`);
    }
}

// üé¨ COMBINED INITIALIZATION - Single DOMContentLoaded listener to prevent race conditions
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üé¨ Initializing component excellence calendar demo');
    
    const eventManager = new CalendarEventManager();
    const calendar = document.getElementById('event-calendar');
    
    if (!calendar) {
        console.error('‚ùå Calendar element not found');
        return;
    }
    
    // üé® SETUP CALENDAR CUSTOMIZATION FIRST (before any data loading)
    console.log('üé® Setting up event count badges using shared state');
    
    // Custom CSS for day badges
    calendar.customCSS = `
        .simple-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            width: 100%;
            height: 100%;
        }
        
        .day-number {
            font-size: inherit;
            line-height: 1;
        }
        
        .day-badge-container {
            min-height: 12px;
            display: flex;
            justify-content: center;
        }
        
        .event-badge {
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 6px;
            color: white;
            background: var(--ty-color-primary);
            font-weight: 500;
            white-space: nowrap;
        }
    `;
    
    // Day content function that uses shared state for event counts
    calendar.dayContentFn = function(dayContext) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'simple-day';
        
        // Create day number
        const dayNumber = document.createElement('span');
        dayNumber.className = 'day-number';
        dayNumber.textContent = dayContext['day-in-month'];
        dayDiv.appendChild(dayNumber);
        
        // Create badge container
        const badgeContainer = document.createElement('div');
        badgeContainer.className = 'day-badge-container';
        
        // üéØ GET EVENT COUNT FROM SHARED STATE - now with safe access
        const dateKey = `${dayContext['year']}-${dayContext['month'].toString().padStart(2, '0')}-${dayContext['day-in-month'].toString().padStart(2, '0')}`;
        
        // Safe access to shared state through eventManager reference (closure)
        const eventCount = eventManager.getEventCounts()[dateKey] || 0;
        
        // Add badge if there are events
        if (eventCount > 0) {
            const badge = document.createElement('span');
            badge.className = 'event-badge';
            badge.textContent = eventCount.toString();
            badgeContainer.appendChild(badge);
        }
        
        dayDiv.appendChild(badgeContainer);
        return dayDiv;
    };
    
    console.log('‚úÖ Event count badges configured to use shared state');
    
    // üìÖ LOAD INITIAL DATA
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    
    console.log(`üìÖ Loading initial month: ${currentYear}-${currentMonth}`);
    const initialData = await eventManager.loadEvents(currentYear, currentMonth);

    // Simple re-render to show initial badges
    if (initialData && initialData.events && initialData.events.length > 0) {
        safeRefreshCalendar(calendar, 'initial load');
    }
    
    // üéØ Listen for navigation events - instant UI updates, background data loading
    calendar.addEventListener('navigate', async function(event) {
        const { year, month, action, source } = event.detail;
        
        console.log(`üß≠ Navigation: ${action} to ${year}-${month} (from ${source})`);
        
        // Load events for new month
        const data = await eventManager.loadEvents(year, month, { 
            updateHeader: true, 
            showLoader: false 
        });
        
        // Simple re-render to show updated badges
        if (data) {
            safeRefreshCalendar(calendar, `navigation to ${year}-${month}`);
        }
    });
    
    // üîç SETUP GLOBAL DEBUGGING HELPERS
    window.calendarDemo = {
        eventManager,
        calendar,
        clearCache: () => eventManager.clearCache(),
        loadMonth: (year, month) => eventManager.loadEvents(year, month),
        getCacheStatus: () => {
            console.log('üìä Cache status:', {
                size: eventManager.cache.cache.size,
                keys: Array.from(eventManager.cache.cache.keys()),
                loading: Array.from(eventManager.loadingStates)
            });
        },
        forceCalendarRerender: () => safeRefreshCalendar(calendar, 'manual debug')
    };
    
    console.log('‚úÖ Calendar demo initialized');
    console.log('üõ†Ô∏è Debug tools available: window.calendarDemo');
});



</script>
{% endblock %}
