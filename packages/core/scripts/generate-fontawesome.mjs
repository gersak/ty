#!/usr/bin/env node
/**
 * FontAwesome 6 Generator for TypeScript
 * Generates TypeScript icon files from FontAwesome 6 repository
 * 
 * FontAwesome 6 has 3 styles:
 * - regular: Regular style icons
 * - brands: Brand logos
 * - solid: Solid style icons
 * 
 * Similar to: gen/ty/generate/fav6.clj
 * 
 * IMPORTANT: FontAwesome icons get currentColor attributes added!
 */

import { execSync } from 'child_process'
import { makeSafeIdentifier } from './reserved-words.mjs'
import { existsSync, mkdirSync, readdirSync, readFileSync, writeFileSync, rmSync } from 'fs'
import { join, basename } from 'path'
import { parseString, Builder } from 'xml2js'

const ROOT = '.icons'
const REPO_URL = 'https://github.com/FortAwesome/Font-Awesome.git'
const REPO_PATH = join(ROOT, 'fontawesome')
const OUTPUT_DIR = 'src/icons/fontawesome'

const STYLES = ['regular', 'brands', 'solid']

function ensureRoot() {
  if (!existsSync(ROOT)) {
    mkdirSync(ROOT, { recursive: true })
  }
}

function cloneRepo() {
  console.log('üì¶ Cloning FontAwesome repository...')
  try {
    execSync(`git clone --depth 1 ${REPO_URL} ${REPO_PATH}`, { stdio: 'inherit' })
    console.log('‚úÖ Repository cloned')
  } catch (error) {
    console.error('‚ùå Failed to clone repository:', error.message)
    process.exit(1)
  }
}

function cleanRepo() {
  if (existsSync(REPO_PATH)) {
    console.log('üßπ Cleaning up repository...')
    rmSync(REPO_PATH, { recursive: true, force: true })
    console.log('‚úÖ Repository cleaned')
  }
}

function listIcons(style) {
  const iconsPath = join(REPO_PATH, 'svgs', style)

  if (!existsSync(iconsPath)) {
    console.error(`‚ùå Icons directory not found: ${iconsPath}`)
    return []
  }

  return readdirSync(iconsPath)
    .filter(file => file.endsWith('.svg'))
    .map(file => join(iconsPath, file))
}

function toCamelCase(str) {
  return str.replace(/-([a-z0-9])/g, (_, letter) => letter.toUpperCase())
}

function toValidIdentifier(name) {
  // Remove .svg extension
  name = name.replace(/\.svg$/, '')

  // Replace invalid characters
  name = name.replace(/[^a-zA-Z0-9-]/g, '-')

  // Remove consecutive hyphens
  name = name.replace(/-+/g, '-')

  // Remove leading/trailing hyphens
  name = name.replace(/^-+|-+$/g, '')

  // If starts with number, prefix with 'icon-'
  if (/^\d/.test(name)) {
    name = 'icon-' + name
  }

  const identifier = toCamelCase(name)

  // Make safe by avoiding JS reserved words
  return makeSafeIdentifier(identifier)
}

/**
 * Add currentColor attributes to SVG
 * FontAwesome icons need these attributes!
 */
function addCurrentColorAttributes(svgContent) {
  return new Promise((resolve, reject) => {
    parseString(svgContent, (err, result) => {
      if (err) {
        reject(err)
        return
      }

      // Add attributes to svg element
      if (!result.svg.$) {
        result.svg.$ = {}
      }

      result.svg.$['stroke-width'] = '0'
      result.svg.$.stroke = 'currentColor'
      result.svg.$.fill = 'currentColor'

      const builder = new Builder({ headless: true })
      resolve(builder.buildObject(result))
    })
  })
}

async function processSvg(path) {
  let svgContent = readFileSync(path, 'utf-8')
  const fileName = basename(path)
  const iconName = fileName.replace(/\.svg$/, '')
  const identifier = toValidIdentifier(iconName)

  // Add currentColor attributes (FontAwesome needs this!)
  try {
    svgContent = await addCurrentColorAttributes(svgContent)
  } catch (error) {
    console.warn(`‚ö†Ô∏è  Failed to process ${iconName}, using original SVG`)
  }

  const cleanedSvg = svgContent
    .replace(/<\?xml[^>]*\?>/g, '')
    .trim()

  const escapedSvg = cleanedSvg
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$/g, '\\$')

  return { identifier, iconName, svg: escapedSvg }
}

function generateTypeScript(icons, style) {
  const exportName = `fontAwesome${style.charAt(0).toUpperCase() + style.slice(1)}`

  const lines = [
    '/**',
    ` * FontAwesome 6 ${style.toUpperCase()} - Auto-generated`,
    ' * DO NOT EDIT THIS FILE MANUALLY',
    ' * Generated from: https://github.com/FortAwesome/Font-Awesome',
    ` * Style: ${style}`,
    ` * Total icons: ${icons.length}`,
    ' *',
    ' * Note: FontAwesome icons have currentColor attributes added',
    ' */',
    ''
  ]

  // Track used identifiers to avoid duplicates
  const usedIdentifiers = new Set()
  const skippedIcons = []

  // Individual constants
  for (const icon of icons) {
    if (usedIdentifiers.has(icon.identifier)) {
      skippedIcons.push(icon.iconName)
      console.warn(`‚ö†Ô∏è  Skipping duplicate: ${icon.identifier} (${icon.iconName})`)
      continue
    }

    usedIdentifiers.add(icon.identifier)
    lines.push(`export const ${icon.identifier} = \`${icon.svg}\``)
  }

  lines.push('')
  lines.push('/** Icon registry - OPTIONAL */')
  lines.push(`export const ${exportName}: Record<string, string> = {`)

  for (const icon of icons) {
    if (!usedIdentifiers.has(icon.identifier)) continue
    lines.push(`  '${icon.iconName}': ${icon.identifier},`)
  }

  lines.push('}')
  lines.push('')
  lines.push(`export const ICON_COUNT = ${usedIdentifiers.size}`)
  lines.push(`export const ICON_NAMES = Object.keys(${exportName})`)

  if (skippedIcons.length > 0) {
    console.log(`‚ö†Ô∏è  Skipped ${skippedIcons.length} duplicate icons`)
  }

  return lines.join('\n')
}

async function generateStyle(style) {
  console.log(`\nüìã Processing ${style} icons...`)

  const iconPaths = listIcons(style)
  console.log(`‚úÖ Found ${iconPaths.length} icons`)

  if (iconPaths.length === 0) {
    console.warn(`‚ö†Ô∏è  No icons found for ${style}`)
    return
  }

  console.log('‚öôÔ∏è  Processing SVGs and adding currentColor attributes...')
  const icons = await Promise.all(iconPaths.map(processSvg))
  const tsContent = generateTypeScript(icons, style)

  const outputPath = join(OUTPUT_DIR, `${style}.ts`)
  const outputDir = join(outputPath, '..')

  if (!existsSync(outputDir)) {
    mkdirSync(outputDir, { recursive: true })
  }

  writeFileSync(outputPath, tsContent, 'utf-8')
  console.log(`‚úÖ Generated ${outputPath}`)

  const fileSize = (tsContent.length / 1024).toFixed(2)
  console.log(`   File size: ${fileSize} KB`)
}

async function generate() {
  console.log('üé® FontAwesome 6 Generator for TypeScript')
  console.log('==========================================\n')

  ensureRoot()

  if (!existsSync(REPO_PATH)) {
    cloneRepo()
  } else {
    console.log('üìÅ Using existing repository')
  }

  // Generate all styles
  for (const style of STYLES) {
    await generateStyle(style)
  }

  cleanRepo()

  console.log('\n‚úÖ Generation complete!')
  console.log('\nüí° Usage:')
  console.log('   import { heart, star } from \'./ts/icons/fontawesome/solid.js\'')
  console.log('   import { github, twitter } from \'./ts/icons/fontawesome/brands.js\'')
}

try {
  await generate()
} catch (error) {
  console.error('\n‚ùå Generation failed:', error)
  process.exit(1)
}
